if ($('#safe-to-alter-layout').html() === "true") {
  setRenderTimestamp(<%= @render_timestamp %>)

  <% if @update_client_title %>
    updatePageTitle('<%= escape_javascript(@thought_wall.title) %>');
    thoughtWallTitleInput.val('<%= @thought_wall.title %>');
  <% end %>

  <% @thoughts.each do |thought| %>
    thought_box_id_selector = "#thought-box-<%= thought.id.to_s %>"
    
    thoughtBoxIsNewToClient = ($(thought_box_id_selector).length == 0);
    if (thoughtBoxIsNewToClient) {
      thoughtListDiv.prepend("<%= escape_javascript(render(:partial => 'thoughts/thought_box', :locals => {:thought => thought, :is_new_thought => true})) %>");
      $(thought_box_id_selector).animate({width: 215}, 500, function() { $(this).animate({opacity: 1.0}, 175, function() { $(this).removeClass('new-thought-box'); }) });
    } else {
      $(thought_box_id_selector).replaceWith("<%= escape_javascript(render(:partial => 'thoughts/thought_box', :locals => {:thought => thought})) %>");
    }
  <% end %>
  
  var clientOrder;
  clientOrder = [];
  $(".thought-box").each(function(){ clientOrder.push(this.id.split("-")[2]); });
  
  var serverUIOrder;
  serverOrder = [];
  <% @thought_wall.thoughts.ui_order.each do |t| %>
    serverOrder.push('<%= t.id %>');
  <% end %>
  
  console.log("client: " + clientOrder);
  console.log("server: " + serverOrder);
  
  var index;
  index = 0;
  while (index < clientOrder.length && clientOrder[index] === serverOrder[index]) {
    index++;
  }
  
  if (index < clientOrder.length) {
    shiftThought($('#thought-box-'+serverOrder[index]).index(), index);
  }
  
  console.log("client boxes: " + clientOrder.length + " :: ending index: " + index);
}

setNextThoughtWallRefreshDelay(<%= @next_refresh %>);
<% if @thoughts.count > 0 || @update_client_title %>
  delayAction(ajaxRefreshPage, minThoughtWallRefreshDelay);
<% else %>
  delayAction(ajaxRefreshPage, getCurrThoughtWallRefreshDelay());
<% end %>